/**
 * Defines a number of tasks used in setting up Nova
 *
 * This file will handle downloading MCP, patching the MCP code, generating the
 * patch file, and ensuring that the user has all the dependencies that they need.
 */

task help {
    doLast {
    logger.info('''\
Allows you to set up Nova on a new machine. This script also checks that you have all the things that Nova needs, that they're on your PATH, and all the other fun stuff.

Available tasks:

 * setup                - Downloads MCP, unzips it, moves it to the right place, and applies the source code transformations to Minecraft so that Nova will be run properly. Before any of that, though, this tasks checks that you have all the right programs installed to your PATH

 * makePatch            - makes the source code patch that Nova uses to distribute its changes to the MC source code

 * verifyEnvironment    - Checks that you have all the right tools on your PATH
''')
    }
}

task setup(dependsOn: verifyEnvironment, initSubmodules) {
    doLast {
        logger.info('Nova setup succesfully')
    }
}

task verifyEnvironment {
    doLast {
        checkCMake()
        checkJava()

        def gccAvailable = hasGCC()
        def msvcAvailable = hasMSVC()

        if(!msvcAvailable) {
            logger.warn("Could not find MCVS. If you want to use MSVC to compile Nova, please use the Visual Studio Developer Command Prompt (just Google it)")
        }

        if(!gccAvailable && !msvcAvailable) {
            logger.fatal('Neither Visual Stusio not GCC are available. Please install one of these and add its location to your PATH')
            throw new GradleScriptException()
        }

        logger.info('All build tools detected')
    }
}
task makeMcpDir {
    def mcpDir = new File(project.buildDir, "mcp")
    if(!mcpDir.exists()) {
        mcpDir.mkdirs()
    }
}

task unzipMcp(type: Copy, dependsOn: makeMcpDir) {

    def zipPath = project.configurations.compile.find {it.name.startsWith("mcp") }
    println zipPath
    def zipFile = file(zipPath)
    def outputDir = file("${buildDir}/mcp")

    from zipTree(zipFile)
    into outputDir
}

task decompileMcp(dependsOn: unzipMcp) {
    def decompileResult = "mcp/decompile.bat".execute()
    if(decompileResult.exitValue() > 0) {
        logger.error('Could not decompile MCP. Check the output log, fix those problems, and try again')
        throw new GradleScriptException()
    }
}

task copyMcCode(type: Copy, dependsOn: decompileMcp) {
    from 'mcp/src/minecraft'
    into 'src/main/java'
}

task copyMcAssets(type: Copy, dependsOn: copyMcCode) {
    from 'mcp/temp/src/minecraft/assets'
    into 'src/main/resources/assets'
}

task copyMcPack(type: Copy, dependsOn: copyMcAssets) {
    from 'mcp/temp/src/minecraft/pack.png'
    into 'src/main/resources/pack.png'
}

task copyJars(type: Copy, dependsOn: copyMcPack) {
    from 'mcp/jars'
    into 'jars'
}

task applyPatch(type: Exec, dependsOn: copyJars) {
    commandLine '../../../../mcp/runtime/bin/applydiff.exe' '-p1' '-i' '../../../../patches/nova.patch'
    workingDir 'src/main/java/net'
}

task cleanupMcp(dependsOn: applyPatch) {
    def mcpDir = file('mcp')
    mcpDir.delete()
}

task initSubmodules(type: Exec, dependsOn: cleanupMcp) {
    commandLine 'git' 'submodule' 'update' '--init' '--recursive'
}

static void checkCMake() {
    def cmakeTest = "cmake --version".execute()
    if(!cmakeTest.exitValue()) {
        println 'CMake not found. Please install CMake and add its location to your PATH'
        throw new GradleScriptException()
    }
}

static boolean hasGCC() {
    def gccTest = "gcc --version".execute()
    return gccTest.exitValue() == 0
}

static boolean hasMSVC() {
    def msvcTest = "msbuild.exe --version".execute()
    return msvcTest.exitValue() == 0
}

static void checkJava() {
    def javaTest = "javac -version".execute()
    if(!javaTest.exitValue()) {
        println 'JDK not found. Please install the Java 8 JDK and add its location to your PATH'
        throw new GradleScriptException()
    }
}

repositories {
    ivy {
        url 'http://www.modcoderpack.com/website/sites/default/files/'
        layout 'pattern', {
            artifact '[classifier]/[module][revision].[ext]'
        }
    }
}

dependencies {
    compile 'mcp:mcp:931:release@zip'
}